# 4.1 데이터베이스의 기본

- 데이터베이스 - 일정한 규칙, 규약을 통해 구조화 되어 저장되는 데이터의
  모음
- DBMS - 해당 데이터베이스를 제어, 관리하는 통합시스템
- 데이터베이스 안에 있는 데이터들은 특정 DBMS마다 정의된 쿼리 언어를 통해
  삽입, 삭제, 수정, 조회 등을 수행할 수 있음
- 데이터베이스는 실시간 접근과 동시공유가 가능함

## 4.1.1 엔터티

사람, 장소, 물건, 사건, 개념 등 여러 개의 속성을 지닌 명사

**예시**

회원이라는 엔터티에 이름, 아이디, 주소, 전화번호 같은 속성이 서비스
요구사항에 맞춰 정해짐

### 약한 엔터티와 강한 엔터티

엔터티는 약한 엔터티와 강한 엔터티로 나뉨

**예시**

방은 건물 안에만 존재함

- 방: 약한 엔터티
- 건물: 강한 엔터티

즉, 종속적인 게 약한 엔터티, 아닌 게 강한 엔터티

## 4.1.2 릴레이션

데이터베이스에서 정보를 구분하여 저장하는 기본 단위

데이터베이스는 릴레이션 하나에 담아서 "엔터티에 관한 데이터"를 관리함

- 관계형 데이터베이스에서는 테이블
- NoSQL 데이터베이스에서는 컬렉션

**구조 예시**

- MySQL → 레코드 - 테이블 - 데이터베이스
- MongoDB → 도큐먼트 - 컬렉션 - 데이터베이스

## 4.1.3 속성

속성은 릴레이션에서 관리하는 구체적이며 고유한 이름을 갖는 정보

## 4.1.4 도메인

릴레이션에 포함된 각각의 속성들이 가질 수 있는 값의 집합

**예시**

성별(속성) → {남, 여} 라는 도메인을 가질 수 있음

## 4.1.5 필드와 레코드

테이블에 쌓이는 행 단위의 데이터를 레코드(튜플)라고 함

### 필드 타입 (MySQL 기준)

#### 숫자 타입

- TINYINT (1 byte), SMALLINT(2 byte), MEDIUMINT(3 byte), INT(4 byte), BIGINT(8 byte)...

#### 날짜 타입

- DATE, DATETIME, TIMESTAMP ...

**DATE**

- 날짜 부분은 있고, 시간 부분은 없는 값
- 지원범위: 1000-01-01 ~ 9999-12-31
- 용량: 3 바이트

**DATETIME**

- 날짜 부분 있고, 시간 부분도 있는 값
- 지원범위: 1000-01-01 00:00:00 ~ 9999-12-31 23:59:59
- 용량: 8 바이트

**TIMESTAMP**

- 날짜 부분 있고, 시간 부분도 있는 값
- 지원범위: 1970-01-01 00:00:01 ~ 2038-01-19 03:14:07
- 용량: 4 바이트

#### **왜 이런 범위를 가지게 되었을까?!**

> 지원범위: 1970-01-01 00:00:01 ~ 2038-01-19 03:14:07

유닉스 타임스탬프가 만들어질 당시 대부분 32bit OS밖에 존재하지 않았다.
32bit INT 범위 = -2³¹ ~ 2³¹-1
unsigned integer를 사용하면 2³²-1 까지 가능하지만 1970-01-01 이전을
표현할 수 없었음 → signed integer 사용
따라서 1970-01-01 00:00:00 + (2³¹-1초) = 2038-01-19 03:14:07

#### 문자 타입

- CHAR, VARCHAR, TEXT, BLOB, ENUM, SET ...

**CHAR와 VARCHAR**

- CHAR: 고정길이 문자열 (0~255)
- 예: CHAR(100) 선언 후 10글자 저장해도 100바이트 차지

- VARCHAR: 가변길이 문자열 (0~65,535)
- 예: 10글자 이메일 저장 → 10바이트 + 길이 기록용 1바이트

**TEXT와 BLOB**

- TEXT: 큰 문자열 저장 (게시판 본문 등)
- BLOB: 이미지, 동영상 등 큰 데이터 저장
  (하지만 이미지의 경우는 보통 S3에 파일 저장 후 경로를 VARCHAR로 저장함)

**ENUM과 SET**

- ENUM: 최대 65,535개의 요소
- SET: 여러 개 선택 가능, 비트 단위 연산, 최대 64개의 요소

## 4.1.6 관계

여러 개의 테이블은 서로의 관계가 정의되어 있으며 관계 화살표로 표현

- 1:1 관계 → 유저당 유저 이메일 한 개
- 1:N 관계 → 한 유저당 여러 개의 상품을 장바구니에 넣는 경우 (0개 포함
  가능)
- N:M 관계 → 학생과 강의 관계 (1:N, 1:M으로 풀어서 구축)

## 4.1.7 키

테이블 간의 관계를 명확히 하고, 인덱스를 위해 설정된 장치

- 기본키(PK)
- 외래키(FK)
- 후보키
- 슈퍼키
- 대체키

### 기본키

- 유일성과 최소성을 만족하는 키
- 자연키 / 인조키 중 선택

**자연키**: 중복되지 않는 속성 (언젠가는 변할 수 있음)

**인조키**: 인위적으로 생성, 변하지 않음 (보통 기본키로 사용)

### 외래키

- 다른 테이블의 기본키를 참조
- 개체 관계를 식별하는 데 사용
- 중복 가능

### 후보키

- 기본키가 될 수 있는 후보들 (유일성 + 최소성 만족)

### 대체키

- 후보키가 여러 개일 때, 기본키로 선택되지 않은 것들

### 슈퍼키

- 각 레코드를 유일하게 식별할 수 있는 키 (유일성 보장)

# 4.2 ERD와 정규화 과정

- ERD = 릴레이션 간의 관계들을 정의한 것

## 4.2.1 ERD의 중요성

시스템의 요구사항을 기반으로 ERD를 작성함
그리고 이 ERD를 기반으로 데이터베이스를 구축함

## 4.2.3 정규화 과정

릴레이션 간의 잘못된 종속관계로 인해 데이터베이스 이상 현상이 일어나서 이를 해결하거나,
저장공간을 효율적으로 사용하기 위해 릴레이션을 여러 개로 분리하는 과정

- 정규화 과정은 정규형 원칙을 기반으로 정규형을 만들어가는 과정

- 기본 정규형 : 제1정규형, 제2정규형, 제3정규형, 보이스/코드 정규형

- 고급 정규형 : 제4정규형, 제5정규형

### 정규형 원칙

1. 같은 의미를 표현하는 릴레이션이지만 좀 더 좋은 구조로 만들기
2. 자료의 **중복성** 감소해야함
3. 독립적인 관계는 별개의 릴레이션으로 표현
4. 각각의 릴레이션은 독립적인 표현이 가능해야함

### 제1정규형

릴레이션의 모든 도메인이 더 이상 분해될 수 없는 **원자** 값만으로 구성되어야함

릴레이션의 속성값 중에서 한 개의 기본키에 대해 두 개이상의 값을 가지는 반복 집합이 있어서는 안됨

### 제2정규형

릴레이션이 제 1정규형이며 **부분함수의 종속성**을 제거한 형태

부분함수의 종속성 제거 = 기본키가 아닌 모든 속성이 기본키에 완전 함수 종속적인 것

### 주의할점

릴레이션을 분해할 때 동등한 릴레이션으로 분해

정보 손실이 발생하지 않는 **무손실** 분해로 분해되어야함

### 제3정규형

제2정규형이고, 기본키가 아닌 모든 속성이 이행적함수종속을 만족하지 않는 상태를 말함

**이행적 함수 종속 이란?**

A→ B와 B→C 가 존재하면 논리적으로 A→C가 성립하는데,

집합 C가 집합 A에 이행적으로 함수 종속되었다고 말함

### 보이스/코드 정규형

제3정규형이고, 결정자가 후보키가 아닌 함수종속관계를 제거하여 릴레이션의 함수 종속 관계에서 모든 결정자가 후보키인 상태를 말함

> => 즉, 후보키가 아닌 속성이 다른 속성을 결정하면 안 된다는 뜻

**결정자**

함수 종속관계에서 특정 종속자를 결정짓는 요소

X→Y일때 X = 결정자, Y=종속자 라고 함

## 4.3 트랜잭션과 무결성

### 4.3.1 트랜잭션

데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위

1. 원자성 (A)

> ALL OR NOTHING

트랜잭션과 관련된 일이 모두 수행되었거나 되지 않았거나를 보장하는 특징

**커밋과 롤백**

**커밋**

1. 여러 쿼리가 성종적으로 처리되었다고 확정하는 명령어
2. 트랜잭션 단위로 수행되며 변경된 내용이 모두 영구적으로 저장됨
3. 커밋이 수행되었다 = 하나의 트랜잭션이 성공적으로 수행되었다

**롤백**

트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 일

커밋과 롤백을 통해서 데이터의 무결성이 보장된다!

**트랜잭션 전파**

여러 트랜잭션 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것

```java
@Service
@Transactional(readOnly=true)
public class MemberService {
	private final MemberRepository memberRepository;

	public MemberService(MemberRepository memberRepository) {
		this.memberRepository = memberRepository;
	}
}
```

2. 일관성 (C)

> CONSISTENCY

‘허용된 방식’으로만 데이터를 변경해야하는 것을 의미함

3. 격리성 (I)

> ISOLATION

트랜잭션 수행 시 서로 끼어들지 못하는 것을 말함

격리성은 여러 개의 격리 수준으로 나뉘어 격리성을 보장함

**격리수준에 따라 발생하는 현상**

1 팬텀리드
2 반복 가능하지 않은 조회
3 더티 리드

1 팬텀리드

한 트랜잭션 내에서 동일한 쿼리를 보냈을 때 해당 조회 결과가 다른 경우

2 반복 가능하지 않은 조회

한 트랜잭션 내의 같은 행에 두 번 이상 조회가 발생했는데, 그 값이 다른 경우를 가리킴

팬텀리드와 다른 점은 반복 가능하지 않은 조회는 행 값이 달라질 수도 있는데 팬텀 리드는 다른 행이 선택될 수도 있다는 것을 의미함

3 더티리드

반복가능하지 않은 조회와 유사ㅏ며 한 트랜잭션이 실행 중일때 다른 트랜잭션에 의해 수정되었지만 아직 커밋되지 않은 행의 데이터를 읽을 수 있을 때 발생

**격리수준**

> SERIALIZABLE

트랜잭션을 순차적으로 진행

매우 엄격한 수준으로 격리함

교착상태가 일어날 확률 높고, 가장 성능이 떨어짐

> REPEATABLE_READ

하나의 트랜잭션이 수정한 행을 다른 트랜잭션이 수정할 수 없도록 막지만 새로운 행을 추가하는 것은 막지 않음

> READ_COMMITTED

가장 많이 사용되는 격리수준

커밋이 완료된 데이터에 대해서만 조회 허용

하지만 어떤 트랜잭션이 접근한 행을 다른 트랜잭션이 수정할 수 있음

> READ_UNCOMMITTED

가장 낮은 격리 수준

하나의 트랜잭션이 커밋되기 이전에 다른 트랜잭션에 노출되는 문제가 있지만 가장 빠름

사용하지 않는 것이 이상적임

4. 지속성 (D)

> DURABILITY

성공적으로 수행된 트랜잭션은 영원히 반영되어야함

체크섬 : 중복검사의 한 형태, 오류 정정을 통해 송신된 자료의 무결성을 보호하는 단순한 방법

저널링 : 파일 시스템 또는 데이터베이스 시스템에 변경 사항을 반영하기 전에 로깅하는 것, 트랜잭션 등 변경 사항에 대한 로그를 남기는 것

### 4.3.2 무결성

데이터의 정확성, 일관성, 유효성을 유지하는 것을 말함

무결성의 종류

개체 무결성 : 기본키로 선택된 필드는 빈값 허용 X

참조 무결성 : 서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지해야함

고유 무결성 : 특정 속성에 대해 고유한 값을 가지도록 조건이 조어진 경우 그 속성 값은 모두 고유한 값 가짐

NULL 무결성 : 특정 속성값이 NULL 올 수 없는 조건이면 그 속성 값은 NULL이 될 수 없다는 제약 조건

## 4.4 데이터베이스의 종류

### 4.4.1 관계형 데이터베이스

행과 열을 가지는 표 형식 데이터를 저장하는 형태의 데이터베이스

언어 : SQL 사용해서 조작함

표준 SQL을 지키기는 하지만, 각각의 제품에 특화시킨 SQL을 사용함

오라클 → PL/SQL

SQL Server → T-SQL

MySQL → SQL

#### MySQL

대부분의 운영체제와 호환되며 현재 가장 많이 사용하는 데이터베이스

1. C, C++ 로 만들어짐
2. MyISAM 인덱스 압축 기술, B-트리 기반의 인덱스, 스레드 기반의 메모리 할당 시스템, 매우 빠른 조인, 최대 64개의 인덱스를 제공함

#### PostgreSQL

MySQL 다음으로 개발자들이 선호하는 데이터베이스 기술

디스트 조각이 차지하는 영역을 회수할 수 있는 장치인 VACUUM 이 특징

### 4.4.2 NoSQL 데이터베이스

#### NoSQL (Not only SQL)

SQL을 사용하지 않는 데이터베이스

ex) MongoDB, redis

#### MongoDB

JSON을 통해 데이터에 접근 가능

Binary JSON 형태로 데이터가 저장됨

와이어드타이거 엔진이 기본 스토리지 엔진으로 장착된 키-값 데이터 모델에서 확장된 도큐먼트 기반의 데이터베이스

MongoDB는 도큐먼트를 생성할 때마다 다른 컬렉션에서 중복된 값을 지니기 힘든 유니크한 값인 ObjectID가 생성됨

#### redis

인메모리 데이터베이스이자 키-값 데이터 모델 기반의 데이터베이스

기본적인 데이터 타입은 문자열

최대 512mb까지 저장가능

pub/sub 기능을 통해 채팅 시스템, 다른 데이터베이스 앞단에 두어 사용하는 캐싱 계층, 단순한 키-값이 필요한 세션 정보관리, 정렬된 셋 자료 구조를 이용한 실시간 순위표 서비스에 사용함
